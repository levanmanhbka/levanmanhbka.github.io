---
title: Airflow
date: 2023-12-07 22:34:00 +0800
categories: [MLOPs, Ochestration Tool]
tags: [mlops]     # TAG names should always be lowercase
---

---
## Worflow
Worflow là một tập hợp nhiều Task được sắp xếp theo một thứ tự nhất định, phụ thuộc vào từng bài toán cụ thể. Ví dụ work flow trong việc huấn luyện mô hình Machine Learning sẽ như sau: Data Extraction -> Data Validation -> Data Preparation -> Model Training -> Model Evaludation -> Model Validation.

Các workfow sẽ được mô tả, lập lịch hoặc khởi động chạy, theo dõi quá trình thực hiện các Task trong đó bằng một công cụ gọi là Orchestration Tool
---

## Orchestration Tools Overview
Airflow là một pipeline orchestration tool trong MLOPs, ngoài ra còn có một số tool khác như cron, luigi, airflow, kubeflow, kedro, metaflow, dagster, flyte, prefect, zenml

![Orchestration Tools](/assets/2023-12-07-airflow/orchestration-tools.png){: width="1000" height="400" }
_Cron, Luigi, Airflow, Kubeflow, Kedro, Metaflow, Dagster, Flyte, Prefect, and Zenml (left to right; top to bottom)_
---

## Airflow Architecture
![Airflow Arichitecture](/assets/2023-12-07-airflow/arch-diag-basic.png){: width="1000" height="400" }
_Airflow Airchitecture_

- DAG Directory: Nơi chứa các file.py định nghĩa các workflow
- Scheduler: Khởi động các worfkow và chuyển các workflow cho Executor thực hiện
- Executor: Thực hiện các Task được mô tả trong workflow
- Worker: Executor có thể thực hiện các Task ngay trong process của Sheduler hoặc gửi các Task cho Worker thực hiện ở một process khác.
- Metada Database: Nơi lưu toàn bộ trạng thái và các thông tin metada của các workflow và các Task
- Webserver: Cung cấp User Interface hiển thị các thông tin về workflow và các Task cũng như có thể khởi động một workflow từ GUI Interface

Sau đây chúng ta sẽ đi chi tiết vào từng thành phần của Airflow
---

## Workflow
A workflow được thể hiện dưới dạng một đồ thị không vòng DAG (Directed Acyclic Graph). Trong đó mỗi Node chính là một Task ví dụ:
![Airflow Arichitecture](/assets/2023-12-07-airflow/dag_example.png){: width="1000" height="400" }
_DAG Example_

DAG được định nghĩa bằng một file python, có nhiều cách định nghĩa DAG và Task bên trong nó, tuy nhiên mình thấy sử dụng decorator @dag và @task tường minh nhất. Sau đây là ví dụ một DAG
```python:
@dag(start_date=now, schedule="@daily", catchup=False)
def etl():
    @task()
    def retrieve(src: Dataset) -> dict:
        resp = requests.get(url=src.uri)
        data = resp.json()
        return data["data"]

    @task()
    def to_fahrenheit(temps: dict[int, float]) -> dict[int, float]:
        ret: dict[int, float] = {}
        for year, celsius in temps.items():
            ret[year] = float(celsius) * 1.8 + 32

        return ret

    @task()
    def load(fahrenheit: dict[int, float]) -> Dataset:
        filename = "/tmp/fahrenheit.json"
        s = json.dumps(fahrenheit)
        f = open(filename, "w")
        f.write(s)
        f.close()

        return Dataset(f"file:///{filename}")

    data = retrieve(SRC)
    fahrenheit = to_fahrenheit(data)
    load(fahrenheit)


etl()
```
---

## Task
Task là thành phần thực hiện công việc cơ bản trong Workflow. Có ba loại Task:
- Operators: là loại task được định nghĩa trước giống như thư viện chuẩn chỉ việc gọi là xong, có hai loại Operator là Build In Operator có sẵn trong Airflow, còn một loại là Provider Operator cần cài thêm thông qua providers packages

| Build In Operator | Responsibility |
| :---------------- | :------|
| BashOperator | executes a bash command   |
| BashOperator | executes a bash command|
| PythonOperator| calls an arbitrary Python function|
| EmailOperator | sends an email|

| Provider Operator | Responsibility |
| :---------------- | :------|
| SimpleHttpOperator |
| MySqlOperator |
| PostgresOperator |
| MsSqlOperator |
| OracleOperator |
| JdbcOperator |
| DockerOperator |
| HiveOperator |
| S3FileTransformOperator |
| PrestoToMySqlOperator |
| SlackAPIOperator |



- Sensors: là một trường hợp đặc biệt của Operator, nó làm một nhiệm vụ duy nhất là lắng nghe event sảy ra

- TaskFlow: chính là việc người dùng tự định nghĩa một hàm Python và biến nó thành Task nhờ decorator @task